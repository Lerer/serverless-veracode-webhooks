service: sls-sqs-keys
# app and org for use with dashboard.serverless.com
app: sls-sqs-keys-app
org: yaakovlerer

# You can pin your service to only deploy with a specific Serverless version
# Check out our docs for more details
frameworkVersion: '2'

package:
  exclude:
    - test/**
    - '**/*.test.js'

custom:
  prod:
    Stack: ExampleSite
    LogLevel: info
  dev:
    Stack: ExampleSite
    LogLevel: debug
  settings:
    ACCOUNT_ID: "#{AWS::AccountId}"
    TARGET_REGION: ${self:provider.region}
    logLevel: ${self:custom.${self:provider.stage}.LogLevel}
    GITHUB_APP_ID: 94775
    GITHUB_APP_INSTALL_ID: 13893866

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'}
  region: ap-southeast-2
  apiGateway:
    shouldStartNameWithService: true
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - sqs:SendMessage
      Resource: 
        - { "Fn::GetAtt" : ["ScanChecks","Arn"]}
        - { "Fn::GetAtt" : ["GithubReportBack","Arn"]}
  environment: ${self:custom.settings}

plugins:
  - serverless-pseudo-parameters
  - serverless-iam-roles-per-function

functions:
  githubListener:
    handler: githubHandler.webhookListen
    memorySize: 128
    events:
      - http:
          path: /github
          method: post
  hello:
    handler: handler.checkScanStatus
    memorySize: 128
    events:
      - http:
          path: /checkScanStatus/{appGUID}
          method: get
      - http:
          path: /checkScanStatus/{appGUID}/{sandboxGUID}
          method: get
  sqsHello:
    handler: handler.sqsSingleScanSample
    memorySize: 128
    timeout: 8
    events:
      - sqs:
          arn: 
            Fn::GetAtt:
              - ScanChecks
              - Arn
          batchSize: 1
resources:
  Resources:
    ScanChecks:
      Type: "AWS::SQS::Queue"
      Properties:
        QueueName: "ScanChecks"
    GithubReportBack:
      Type: "AWS::SQS::Queue"
      Properties:
        QueueName: "GithubReportBack"
